## 分布式定时任务

### 前言
例: 自动化 + 定时执行 + 海量数据 + 高效稳定

### 发展历程
从linux命令到单机到分布式

- windows批处理 -- 设置十分钟后关机  .bat文件
- window任务计划程序 -- 疫情自动打卡
- linux 
![](../picture/17linuxCronJob.jpg)
- 单机定时任务 go :ticker
- 任务调度-Quartz
- 分布式定时任务: 前面只支持单机
  - 平台化管理
  - 分布式部署
  - 支持海量数据


![](../picture/17分布式定时任务.jpg)

![](../picture/17执行方式.jpg)
![](../picture/17业内定时任务框架.jpg)


### 实现原理
![](../picture/17实现原理.jpg)
1. 核心架构
   ![](../picture/17核心架构.jpg)
  ![](../picture/17功能架构.jpg)
2. 控制台
  ![](../picture/17控制台基本概念.jpg)
3. 触发器
   核心职责:解析触发规则,在规定的时间点触发任务的调度
  - 方案一![](../picture/17触发器方案1.jpg)
  - 方案2![](../picture/17触发器方案2.jpg)
    - 遍历任务列表,选取数据结构
      - 链表:查询O(n),修改O(1)
      - 最小堆:查询O(1),修改O(logn)
      - 时间轮:查询O(1),修改O(1) ![](../picture/17多级时间轮.jpg)
    - 高可用:不同业务之间, 任务的调度相互影响`or`负责扫描和触发的机器挂了怎么办?
      - 存储上,不同国别、业务做资源隔离
      - 分开运行
      - 多机房多trigger集群化部署,避免单点故障,需避免同一任务被多次触发, 通过数据锁或分布式锁
      - 数据库行锁
        ![](../picture/17数据库行锁.jpg)
      - 分布式锁
        ![](../picture/17分布式锁.jpg)
4. 调度器
   ![](../picture/17资源来源.jpg)
   ![](../picture/17资源来源节点选择.jpg)
   ![](../picture/17任务分片.jpg)
   任务编排:用有向无环图
   
5. 执行器



### 业务应用